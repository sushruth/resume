#!/bin/bash

# Unified CLI for Resume Management
# Usage: ./resume [command]

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print usage
usage() {
    echo "Usage: $0 [command]"
    echo ""
    echo "Commands:"
    echo "  init     Install dependencies (bun install)"
    echo "  build    Sync LaTeX files from careerProfile.json"
    echo "  doctor   Check if required tools are installed"
    echo "  --help   Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 init"
    echo "  $0 build"
    echo "  $0 doctor"
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to check tools
check_tools() {
    local missing_tools=()

    if ! command_exists bun; then
        missing_tools+=("Bun (https://bun.sh)")
    fi

    if ! command_exists pdflatex && ! command_exists xelatex; then
        missing_tools+=("LaTeX (pdflatex or xelatex)")
    fi

    if [ ${#missing_tools[@]} -eq 0 ]; then
        echo -e "${GREEN}✓ All required tools are installed.${NC}"
        return 0
    else
        echo -e "${RED}✗ Missing required tools:${NC}"
        for tool in "${missing_tools[@]}"; do
            echo "  - $tool"
        done
        return 1
    fi
}

# Main logic
case "${1:-}" in
    init)
        echo "Installing dependencies..."
        cd infrastructure/cli
        if command_exists bun; then
            bun install
            echo -e "${GREEN}✓ Dependencies installed successfully.${NC}"
        else
            echo -e "${RED}✗ Bun is not installed. Please install Bun first.${NC}"
            exit 1
        fi
        ;;
    build)
        echo "Building resume..."
        if ! check_tools >/dev/null 2>&1; then
            echo -e "${YELLOW}Warning: Some tools are missing. Build may fail.${NC}"
        fi
        cd infrastructure/cli
        if command_exists bun; then
            bun run sync
            echo -e "${GREEN}✓ Resume synced successfully.${NC}"
            echo "Note: PDF compilation requires LaTeX and is done via GitHub Actions."
        else
            echo -e "${RED}✗ Bun is not installed. Cannot build.${NC}"
            exit 1
        fi
        ;;
    doctor)
        echo "Checking system health..."
        check_tools
        ;;
    --help|-h)
        usage
        ;;
    "")
        echo -e "${RED}Error: No command specified.${NC}"
        usage
        exit 1
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'.${NC}"
        usage
        exit 1
        ;;
esac
